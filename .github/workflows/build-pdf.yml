name: Create a new PDF for each changed MD file

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List changed files
        run: |
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only $(git rev-list --max-parents=0 HEAD) HEAD)
          else
            CHANGED_FILES=$(git log --name-only --pretty=format: --diff-filter=A | sort -u)
          fi
          echo "$CHANGED_FILES" > changed_files.txt

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install pandoc
          sudo apt-get install texlive-latex-recommended

      - name: Convert each changed MD file to PDF
        run: |
          while IFS= read -r file; do
            if [[ $file == *.md ]]; then
              pandoc -H ../tools/head.tex --pdf-engine=xelatex "$file" -o "pdf/${file%.md}.pdf" -s -V fontsize=12pt -V geometry:"top=2cm, bottom=1.5cm, left=2cm, right=2cm" --resource-path="z_images"
            fi
          done < changed_files.txt
          rm changed_files.txt

      - name: Commit and push PDFs
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add pdf/*.pdf
          git commit -m "Add generated PDFs"
          git push